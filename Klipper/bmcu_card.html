<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BMCU MMU Control</title>
<style>
  :root {
    /* Fluidd-like dark palette */
    --bg: transparent;
    --card: #1f232b;
    --card-2: #242933;
    --card-border: #2c3038;
    --muted: #9aa3b5;
    --text: #e5e8ee;
    --accent: #48a0ff;
    --accent-2: #3cc47c;
    --danger: #d9534f;
    --shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 12px;
    font-family: "Inter", "Segoe UI", system-ui, sans-serif;
    background: transparent;
    color: var(--text);
  }
  h1 { display: none; }
  .card {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 10px;
    padding: 12px;
    box-shadow: var(--shadow);
    width: 100%;
    max-width: 1260px;
    margin: 0 auto;
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
      gap: 8px;
      border-bottom: 1px solid var(--card-border);
      padding-bottom: 8px;
      margin-bottom: 10px;
  }
  .title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .card-title {
    font-size: 1.15rem;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .card-subtitle {
    color: var(--muted);
    font-size: 0.9rem;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
    text-align: right;
  }
  #timestamp {
    color: var(--muted);
    font-size: 0.9rem;
  }
  .button-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
    .btn {
      border: 1px solid transparent;
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 0.88rem;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    box-shadow: 0 6px 14px rgba(58, 123, 213, 0.3);
  }
  .btn:hover { transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn.ghost {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--card-border);
    color: var(--text);
    box-shadow: none;
  }
  .btn.ghost:hover { border-color: var(--accent); }
  .btn.danger {
    background: var(--danger);
    box-shadow: 0 6px 14px rgba(224, 101, 101, 0.3);
  }
  .btn.secondary {
    background: #1e2635;
    border-color: var(--card-border);
  }
  #bmcu-container {
    display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      width: 100%;
    }
    .lane-card {
      background: var(--card-2);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 160px;
  }
  .lane-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .lane-title {
    font-weight: 600;
    letter-spacing: 0.2px;
  }
  .pill {
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    border: 1px solid var(--card-border);
    color: var(--muted);
    background: rgba(255, 255, 255, 0.03);
  }
  .pill.present {
    color: var(--accent-2);
      border-color: rgba(60, 196, 124, 0.4);
  }
  .info {
    display: grid;
    grid-template-columns: 1fr;
      gap: 3px;
    }
    .info div {
      font-size: 0.88rem;
      color: var(--muted);
  }
  .info strong {
    color: var(--text);
    font-weight: 600;
  }
  .color-swatch {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 1px solid var(--card-border);
    background: #3a3a3a;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
  }
  .buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
  }
  .buttons button {
      font-size: 0.82rem;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.03);
    color: var(--text);
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
  }
  .buttons button:hover {
      background: rgba(72, 160, 255, 0.12);
      border-color: rgba(72, 160, 255, 0.45);
  }
  .buttons button:active { transform: translateY(1px); }
  .buttons button.full {
    grid-column: 1 / -1;
  }
  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(2px);
    z-index: 20;
    padding: 16px;
  }
  .modal.hidden { display: none; }
    .modal-content {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 16px;
    width: min(420px, 100%);
    box-shadow: var(--shadow);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .modal-title {
    font-weight: 600;
    letter-spacing: 0.2px;
  }
  .icon-button {
    border: none;
    background: rgba(255, 255, 255, 0.06);
    color: var(--text);
    border-radius: 8px;
    width: 32px;
    height: 32px;
    font-size: 1.1rem;
    cursor: pointer;
  }
  .form-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 10px;
  }
  label {
    font-size: 0.9rem;
    color: var(--muted);
  }
  input {
    background: #0c1019;
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--text);
    font-size: 0.95rem;
  }
  input:focus {
    outline: 1px solid var(--accent);
    border-color: var(--accent);
  }
  .color-inputs {
    display: flex;
    gap: 8px;
  }
  .color-inputs input[type="color"] {
    padding: 0;
    width: 48px;
    min-width: 48px;
    border-radius: 8px;
    border: 1px solid var(--card-border);
    background: none;
    height: 40px;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 6px;
  }
  @media (max-width: 640px) {
    .card-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .header-actions {
      width: 100%;
      justify-content: space-between;
    }
    .button-row {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="title-block">
        <div class="card-title">BMCU MMU</div>
        <div class="card-subtitle">Lane status and controls</div>
      </div>
      <div class="header-actions">
        <span id="timestamp">Awaiting first update...</span>
        <div class="button-row">
          <button class="btn ghost" onclick="refreshStatus()">Refresh</button>
          <button class="btn danger" onclick="stopAll()">Stop all</button>
        </div>
      </div>
    </div>
    <div id="bmcu-container">
      <!-- Lane 0 -->
      <div class="lane-card" id="lane0">
        <div class="lane-header">
          <div class="lane-title">Lane 0</div>
          <span class="pill" id="lane0_presence">--</span>
        </div>
        <div class="info">
          <div><strong>Name:</strong> <span id="lane0_name">--</span></div>
          <div><strong>Temp:</strong> <span id="lane0_temp">--</span></div>
          <div><strong>RFID:</strong> <span id="lane0_rfid">--</span></div>
          <div><strong>Meters:</strong> <span id="lane0_meters">--</span></div>
          <div><strong>Status:</strong> <span id="lane0_status">--</span></div>
          <div class="color-swatch"><strong>Color:</strong> <span class="color-box" id="lane0_color"></span><span id="lane0_color_hex">--</span></div>
        </div>
        <div class="buttons">
          <button onclick="feedLane(0)">Feed</button>
          <button onclick="retractLane(0)">Retract</button>
          <button id="lane0_autoBtn" onclick="autoToggleLane(0)">Auto On</button>
          <button onclick="selectLane(0)">Select</button>
          <button class="full" onclick="openEditModal(0)">Set Info</button>
        </div>
      </div>
      <!-- Lane 1 -->
      <div class="lane-card" id="lane1">
        <div class="lane-header">
          <div class="lane-title">Lane 1</div>
          <span class="pill" id="lane1_presence">--</span>
        </div>
        <div class="info">
          <div><strong>Name:</strong> <span id="lane1_name">--</span></div>
          <div><strong>Temp:</strong> <span id="lane1_temp">--</span></div>
          <div><strong>RFID:</strong> <span id="lane1_rfid">--</span></div>
          <div><strong>Meters:</strong> <span id="lane1_meters">--</span></div>
          <div><strong>Status:</strong> <span id="lane1_status">--</span></div>
          <div class="color-swatch"><strong>Color:</strong> <span class="color-box" id="lane1_color"></span><span id="lane1_color_hex">--</span></div>
        </div>
        <div class="buttons">
          <button onclick="feedLane(1)">Feed</button>
          <button onclick="retractLane(1)">Retract</button>
          <button id="lane1_autoBtn" onclick="autoToggleLane(1)">Auto On</button>
          <button onclick="selectLane(1)">Select</button>
          <button class="full" onclick="openEditModal(1)">Set Info</button>
        </div>
      </div>
      <!-- Lane 2 -->
      <div class="lane-card" id="lane2">
        <div class="lane-header">
          <div class="lane-title">Lane 2</div>
          <span class="pill" id="lane2_presence">--</span>
        </div>
        <div class="info">
          <div><strong>Name:</strong> <span id="lane2_name">--</span></div>
          <div><strong>Temp:</strong> <span id="lane2_temp">--</span></div>
          <div><strong>RFID:</strong> <span id="lane2_rfid">--</span></div>
          <div><strong>Meters:</strong> <span id="lane2_meters">--</span></div>
          <div><strong>Status:</strong> <span id="lane2_status">--</span></div>
          <div class="color-swatch"><strong>Color:</strong> <span class="color-box" id="lane2_color"></span><span id="lane2_color_hex">--</span></div>
        </div>
        <div class="buttons">
          <button onclick="feedLane(2)">Feed</button>
          <button onclick="retractLane(2)">Retract</button>
          <button id="lane2_autoBtn" onclick="autoToggleLane(2)">Auto On</button>
          <button onclick="selectLane(2)">Select</button>
          <button class="full" onclick="openEditModal(2)">Set Info</button>
        </div>
      </div>
      <!-- Lane 3 -->
      <div class="lane-card" id="lane3">
        <div class="lane-header">
          <div class="lane-title">Lane 3</div>
          <span class="pill" id="lane3_presence">--</span>
        </div>
        <div class="info">
          <div><strong>Name:</strong> <span id="lane3_name">--</span></div>
          <div><strong>Temp:</strong> <span id="lane3_temp">--</span></div>
          <div><strong>RFID:</strong> <span id="lane3_rfid">--</span></div>
          <div><strong>Meters:</strong> <span id="lane3_meters">--</span></div>
          <div><strong>Status:</strong> <span id="lane3_status">--</span></div>
          <div class="color-swatch"><strong>Color:</strong> <span class="color-box" id="lane3_color"></span><span id="lane3_color_hex">--</span></div>
        </div>
        <div class="buttons">
          <button onclick="feedLane(3)">Feed</button>
          <button onclick="retractLane(3)">Retract</button>
          <button id="lane3_autoBtn" onclick="autoToggleLane(3)">Auto On</button>
          <button onclick="selectLane(3)">Select</button>
          <button class="full" onclick="openEditModal(3)">Set Info</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="edit-title">Set lane info</div>
        <button class="icon-button" aria-label="Close" onclick="closeEditModal()">x</button>
      </div>
      <form id="edit-form">
        <input type="hidden" id="field-lane">
        <div class="form-row">
          <label for="field-name">Name</label>
          <input id="field-name" type="text" maxlength="32" autocomplete="off" placeholder="e.g. PLA Orange">
        </div>
        <div class="form-row">
          <label for="field-temp-min">Temp minimum (C)</label>
          <input id="field-temp-min" type="number" inputmode="decimal" placeholder="0">
        </div>
        <div class="form-row">
          <label for="field-temp-max">Temp maximum (C)</label>
          <input id="field-temp-max" type="number" inputmode="decimal" placeholder="0">
        </div>
        <div class="form-row">
          <label for="field-id">RFID / ID (max 8 chars)</label>
          <input id="field-id" type="text" maxlength="8" autocomplete="off">
        </div>
        <div class="form-row">
          <label for="field-meters">Meters remaining</label>
          <input id="field-meters" type="number" inputmode="decimal" min="0" step="0.1" placeholder="leave blank to skip">
        </div>
        <div class="form-row">
          <label for="field-color">Color</label>
          <div class="color-inputs">
            <input id="field-color" type="color" value="#3a7bd5">
            <input id="field-color-hex" type="text" maxlength="7" placeholder="#RRGGBB" autocomplete="off">
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn ghost" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
  let currentLanes = [];
  const autoFeedState = [false, false, false, false];
  let pendingFullRefresh = false;
  let lastDataFingerprint = null;
  let lastFreshUpdate = null;

  const timestampEl = document.getElementById('timestamp');
  const modal = document.getElementById('edit-modal');
  const editForm = document.getElementById('edit-form');
  const fieldLane = document.getElementById('field-lane');
  const fieldName = document.getElementById('field-name');
  const fieldTempMin = document.getElementById('field-temp-min');
  const fieldTempMax = document.getElementById('field-temp-max');
  const fieldId = document.getElementById('field-id');
  const fieldMeters = document.getElementById('field-meters');
  const fieldColor = document.getElementById('field-color');
  const fieldColorHex = document.getElementById('field-color-hex');

  function setTimestampLabel() {
    if (!lastFreshUpdate) {
      timestampEl.textContent = 'Awaiting first update...';
      return;
    }
    const timeStr = lastFreshUpdate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    timestampEl.textContent = 'Last full update: ' + timeStr;
  }

  function buildColorHex(color) {
    if (color && color.length >= 3) {
      return '#' + color.slice(0, 3).map(n => Number(n).toString(16).padStart(2, '0')).join('');
    }
    return '';
  }

  function fetchStatus() {
    fetch('/printer/objects/query?bmcu')
      .then(res => res.json())
      .then(data => {
        if (!data.result || !data.result.status || !data.result.status.bmcu) return;
        const lanes = data.result.status.bmcu.lanes;
        if (!Array.isArray(lanes)) return;

        const fingerprint = JSON.stringify(lanes);
        const dataChanged = lastDataFingerprint !== null && fingerprint !== lastDataFingerprint;
        if (pendingFullRefresh || dataChanged) {
          lastFreshUpdate = new Date();
          pendingFullRefresh = false;
        }
        lastDataFingerprint = fingerprint;

        currentLanes = lanes;
        lanes.forEach((lane, i) => {
          const nameEl = document.getElementById('lane' + i + '_name');
          const tempEl = document.getElementById('lane' + i + '_temp');
          const rfidEl = document.getElementById('lane' + i + '_rfid');
          const metersEl = document.getElementById('lane' + i + '_meters');
          const presenceEl = document.getElementById('lane' + i + '_presence');
          const statusEl = document.getElementById('lane' + i + '_status');
          const colorBox = document.getElementById('lane' + i + '_color');
          const colorHexEl = document.getElementById('lane' + i + '_color_hex');
          const autoBtn = document.getElementById('lane' + i + '_autoBtn');

          nameEl.textContent = lane.name || '--';
          const hasTemps = lane.temp_min !== undefined && lane.temp_max !== undefined;
          tempEl.textContent = hasTemps ? lane.temp_min + ' - ' + lane.temp_max + ' C' : '--';
          rfidEl.textContent = lane.id_str || lane.rfid || '--';
          metersEl.textContent = (lane.meters !== undefined && lane.meters >= 0) ? lane.meters : '--';
          const isPresent = !!lane.present;
          presenceEl.textContent = isPresent ? 'Present' : 'Empty';
          presenceEl.className = 'pill' + (isPresent ? ' present' : '');
          statusEl.textContent = lane.motion || 'Idle';

          const hex = buildColorHex(lane.color) || '';
          colorBox.style.backgroundColor = hex || '#3a3a3a';
          const hexLabel = hex ? hex.toUpperCase() : '--';
          document.getElementById('lane' + i + '_color_hex').textContent = hexLabel;
          colorBox.setAttribute('title', hexLabel);

          autoBtn.textContent = autoFeedState[i] ? 'Auto Off' : 'Auto On';
        });
        setTimestampLabel();
      })
      .catch(err => console.error(err));
  }

  function refreshStatus() {
    pendingFullRefresh = true;
    sendGcode('BMCU_FETCH_STATUS');
    sendGcode('BMCU_CALL CMD=STATUS WAIT=0.3');
    setTimeout(fetchStatus, 700);
  }

  function sendGcode(command) {
    return fetch('/printer/gcode/script', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ script: command })
    }).then(res => res.text()).catch(err => console.error(err));
  }

  function feedLane(i) {
    sendGcode('BMCU_LANE_FEED LANE=' + i);
  }

  function retractLane(i) {
    sendGcode('BMCU_LANE_RETRACT LANE=' + i);
  }

  function autoToggleLane(i) {
    autoFeedState[i] = !autoFeedState[i];
    const enable = autoFeedState[i] ? 1 : 0;
    document.getElementById('lane' + i + '_autoBtn').textContent = autoFeedState[i] ? 'Auto Off' : 'Auto On';
    sendGcode('BMCU_SET_AUTO_FEED LANE=' + i + ' ENABLE=' + enable);
  }

  function selectLane(i) {
    sendGcode('BMCU_SELECT_LANE LANE=' + i);
  }

  function stopAll() {
    sendGcode('BMCU_STOP');
  }

  function openEditModal(i) {
    const lane = currentLanes[i] || {};
    fieldLane.value = i;
    document.getElementById('edit-title').textContent = 'Set lane ' + i + ' info';
    fieldName.value = lane.name || '';
    fieldTempMin.value = lane.temp_min !== undefined ? lane.temp_min : '';
    fieldTempMax.value = lane.temp_max !== undefined ? lane.temp_max : '';
    fieldId.value = lane.id_str || lane.rfid || '';
    fieldMeters.value = (lane.meters !== undefined && lane.meters >= 0) ? lane.meters : '';
    const hex = buildColorHex(lane.color) || '#3a7bd5';
    fieldColor.value = hex;
    fieldColorHex.value = hex.toUpperCase();
    modal.classList.remove('hidden');
  }

  function closeEditModal() {
    modal.classList.add('hidden');
  }

  function normalizeHex(val) {
    if (!val) return '';
    let out = val.trim();
    if (out && out[0] !== '#') out = '#' + out;
    if (/^#([0-9a-fA-F]{6})$/.test(out)) return out;
    return '';
  }

  function syncHexFromPicker() {
    fieldColorHex.value = fieldColor.value.toUpperCase();
  }

  function syncPickerFromHex() {
    const hex = normalizeHex(fieldColorHex.value);
    if (hex) fieldColor.value = hex;
  }

  function hexToRgb(hex) {
    const val = normalizeHex(hex);
    if (!val) return null;
    return {
      r: parseInt(val.slice(1, 3), 16),
      g: parseInt(val.slice(3, 5), 16),
      b: parseInt(val.slice(5, 7), 16)
    };
  }

  editForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const laneIdx = parseInt(fieldLane.value, 10);
    const name = fieldName.value.trim();
    const tmin = fieldTempMin.value.trim();
    const tmax = fieldTempMax.value.trim();
    const idStr = fieldId.value.trim();
    const metersStr = fieldMeters.value.trim();
    const colorStr = normalizeHex(fieldColorHex.value || fieldColor.value);
    const rgb = hexToRgb(colorStr);

    let cmd = 'BMCU_SET_FILAMENT_INFO LANE=' + laneIdx;
    if (name) cmd += ' NAME=' + name;
    if (tmin) cmd += ' TEMP_MIN=' + parseInt(tmin, 10);
    if (tmax) cmd += ' TEMP_MAX=' + parseInt(tmax, 10);
    if (idStr) cmd += ' ID=' + idStr.substring(0, 8);
    if (metersStr !== '') cmd += ' METERS=' + parseFloat(metersStr);
    // Avoid '#' in gcode (treated as comment). Send explicit RGB components.
    if (rgb) {
      cmd += ' COLOR_R=' + rgb.r + ' COLOR_G=' + rgb.g + ' COLOR_B=' + rgb.b;
      // Also send a hex payload without the hash for firmware that accepts it.
      cmd += ' COLOR_HEX=' + colorStr.replace('#', '');
    }

    sendGcode(cmd).then(() => {
      pendingFullRefresh = true;
      refreshStatus();
    });
    closeEditModal();
  });

  fieldColor.addEventListener('input', syncHexFromPicker);
  fieldColorHex.addEventListener('input', syncPickerFromHex);

  window.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeEditModal();
  });

  function init() {
    fetchStatus();
    refreshStatus();
    setInterval(fetchStatus, 5000);
  }

  window.addEventListener('load', init);
</script>
</body>
</html>
