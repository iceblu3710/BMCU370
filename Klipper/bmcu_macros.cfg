# BMCU MMU macros for Klipper (LiteJSON Firmware)
#
# This file defines convenience macros for operating a BMCU-based
# multi-material unit with LiteJSON firmware protocol.
#
# Include in printer.cfg:
#     [include bmcu_macros.cfg]
#
# LiteJSON Firmware Limits:
#   - Filament name: max 20 chars
#   - RFID/ID: max 8 chars  
#   - Color format: [R, G, B, A]
#
# After restarting Klipper, macros appear in Mainsail.
# Drag them into a group named "BMCU MMU" for better organization.

# ------------------------------------------------------------------------------
# Global macros
# ------------------------------------------------------------------------------

[gcode_macro BMCU_STOP_ALL]
description: Stop all BMCU motion
# Use this macro to immediately stop all motion on the BMCU.  It simply calls
# the underlying BMCU_STOP command.
gcode:
    BMCU_STOP

[gcode_macro BMCU_SHOW_STATUS]
description: Show cached BMCU status in the console
# Prints the most recent STATUS reply from the BMCU firmware.  The output
# includes lane objects with fields such as presence, motion, RFID, meters,
# name, temp_min, temp_max and color.
gcode:
    BMCU_STATUS

# ------------------------------------------------------------------------------
# Lane-specific macros
#
# For each lane (0..3) we provide macros to feed, retract, toggle auto
# feeding and select the lane.  These macros rely on the defaults defined
# in your `[bmcu]` configuration for feed distance, retract distance and
# feed speed.  Feel free to duplicate and modify these definitions if you
# want different distances or speeds per lane.
# ------------------------------------------------------------------------------

# ---- Lane 0 ----
[gcode_macro BMCU_SELECT_L0]
description: Select lane 0 as the active filament
# Selects lane 0 so that subsequent commands which rely on the current
# filament (such as BMCU_FEED) operate on this lane.
gcode:
    BMCU_SELECT_LANE LANE=0

[gcode_macro BMCU_FEED_L0]
description: Feed lane 0 by the default distance
# Advances the filament in lane 0 by `default_lane_feed_mm` at
# `default_speed`.  To change the feed distance or speed globally,
# adjust these values in the `[bmcu]` section of `printer.cfg`.
gcode:
    BMCU_LANE_FEED LANE=0

[gcode_macro BMCU_RETRACT_L0]
description: Retract lane 0 by the default distance
# Retracts filament in lane 0 by `default_lane_retract_mm` at the
# default speed.
gcode:
    BMCU_LANE_RETRACT LANE=0

[gcode_macro BMCU_AUTO_ON_L0]
description: Enable auto feed on lane 0
# Enables automatic feeding for lane 0.  Firmware will handle feeding
# when appropriate during printing.
gcode:
    BMCU_SET_AUTO_FEED LANE=0 ENABLE=1

[gcode_macro BMCU_AUTO_OFF_L0]
description: Disable auto feed on lane 0
# Disables automatic feeding for lane 0.
gcode:
    BMCU_SET_AUTO_FEED LANE=0 ENABLE=0

# ---- Lane 1 ----
[gcode_macro BMCU_SELECT_L1]
description: Select lane 1 as the active filament
gcode:
    BMCU_SELECT_LANE LANE=1

[gcode_macro BMCU_FEED_L1]
description: Feed lane 1 by the default distance
gcode:
    BMCU_LANE_FEED LANE=1

[gcode_macro BMCU_RETRACT_L1]
description: Retract lane 1 by the default distance
gcode:
    BMCU_LANE_RETRACT LANE=1

[gcode_macro BMCU_AUTO_ON_L1]
description: Enable auto feed on lane 1
gcode:
    BMCU_SET_AUTO_FEED LANE=1 ENABLE=1

[gcode_macro BMCU_AUTO_OFF_L1]
description: Disable auto feed on lane 1
gcode:
    BMCU_SET_AUTO_FEED LANE=1 ENABLE=0

# ---- Lane 2 ----
[gcode_macro BMCU_SELECT_L2]
description: Select lane 2 as the active filament
gcode:
    BMCU_SELECT_LANE LANE=2

[gcode_macro BMCU_FEED_L2]
description: Feed lane 2 by the default distance
gcode:
    BMCU_LANE_FEED LANE=2

[gcode_macro BMCU_RETRACT_L2]
description: Retract lane 2 by the default distance
gcode:
    BMCU_LANE_RETRACT LANE=2

[gcode_macro BMCU_AUTO_ON_L2]
description: Enable auto feed on lane 2
gcode:
    BMCU_SET_AUTO_FEED LANE=2 ENABLE=1

[gcode_macro BMCU_AUTO_OFF_L2]
description: Disable auto feed on lane 2
gcode:
    BMCU_SET_AUTO_FEED LANE=2 ENABLE=0

# ---- Lane 3 ----
[gcode_macro BMCU_SELECT_L3]
description: Select lane 3 as the active filament
gcode:
    BMCU_SELECT_LANE LANE=3

[gcode_macro BMCU_FEED_L3]
description: Feed lane 3 by the default distance
gcode:
    BMCU_LANE_FEED LANE=3

[gcode_macro BMCU_RETRACT_L3]
description: Retract lane 3 by the default distance
gcode:
    BMCU_LANE_RETRACT LANE=3

[gcode_macro BMCU_AUTO_ON_L3]
description: Enable auto feed on lane 3
gcode:
    BMCU_SET_AUTO_FEED LANE=3 ENABLE=1

[gcode_macro BMCU_AUTO_OFF_L3]
description: Disable auto feed on lane 3
gcode:
    BMCU_SET_AUTO_FEED LANE=3 ENABLE=0

# ------------------------------------------------------------------------------
# Status & Refresh Macros
# ------------------------------------------------------------------------------

[gcode_macro BMCU_FETCH_STATUS]
description: Request fresh STATUS data from the BMCU
gcode:
    # Sends a STATUS command to the BMCU and waits briefly for a reply.
    # This macro can be invoked from the web UI to refresh lane information.
    BMCU_CALL CMD=STATUS WAIT=0.5

[gcode_macro BMCU_REFRESH]
description: Refresh all lane data from BMCU firmware
# Alias for BMCU_FETCH_STATUS with longer wait for reliability
gcode:
    BMCU_CALL CMD=STATUS WAIT=1.0
