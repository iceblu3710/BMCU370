\doxysection{Command\+Router.\+cpp}
\hypertarget{_command_router_8cpp_source}{}\label{_command_router_8cpp_source}\index{src/CommandRouter.cpp@{src/CommandRouter.cpp}}
\mbox{\hyperlink{_command_router_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00002}00002\ \textcolor{comment}{*\ DEVELOPMENT\ STATE:\ TESTING}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00003}00003\ \textcolor{comment}{*\ This\ file\ implements\ command\ routing\ including\ the\ testing\ JSON\ protocol.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00004}00004\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00005}00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_command_router_8h}{CommandRouter.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00006}00006\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_bambu_bus_protocol_8h}{BambuBusProtocol.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00007}00007\ \textcolor{preprocessor}{\#ifdef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00008}00008\ \textcolor{preprocessor}{\#include\ "{}SerialCLI.h"{}}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00009}00009\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00010}00010\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_klipper_c_l_i_8h}{KlipperCLI.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00011}00011\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_hardware_8h}{Hardware.h}}"{}}\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00012}00012\ \textcolor{preprocessor}{\#include\ <stdio.h>}\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00013}00013\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_control_logic_8h}{ControlLogic.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00014}00014\ \textcolor{preprocessor}{\#include\ <string.h>}\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00016}\mbox{\hyperlink{namespace_command_router}{00016}}\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespace_command_router}{CommandRouter}}\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00018}\mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{00018}}\ \ \ \ \ \textcolor{keyword}{static}\ uint64\_t\ \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\_packet\_time}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00019}\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{00019}}\ \ \ \ \ \textcolor{keyword}{static}\ uint8\_t\ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}}[1024];}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00020}\mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{00020}}\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ uint16\_t\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00021}\mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{00021}}\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00023}00023\ \ \ \ \ \textcolor{comment}{//\ -\/-\/-\/\ Routing\ Table\ Definition\ -\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00024}\mbox{\hyperlink{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1}{00024}}\ \ \ \ \ \textcolor{keyword}{typedef}\ void\ (*\mbox{\hyperlink{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1}{PacketHandler}})(uint8\_t*\ buffer,\ uint16\_t\ length);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00026}\mbox{\hyperlink{struct_command_router_1_1_route_entry}{00026}}\ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_command_router_1_1_route_entry}{RouteEntry}}\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00027}\mbox{\hyperlink{struct_command_router_1_1_route_entry_a5a9d14ce26be69f57a6db7a6028240c0}{00027}}\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{UnifiedCommandType}}\ \mbox{\hyperlink{struct_command_router_1_1_route_entry_a5a9d14ce26be69f57a6db7a6028240c0}{type}};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00028}\mbox{\hyperlink{struct_command_router_1_1_route_entry_ae4d921ac8145274d9e70464a1274732a}{00028}}\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1}{PacketHandler}}\ \mbox{\hyperlink{struct_command_router_1_1_route_entry_ae4d921ac8145274d9e70464a1274732a}{handler}};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00029}\mbox{\hyperlink{struct_command_router_1_1_route_entry_a5f8e8773587531b8d5dfe46e04bfbc1c}{00029}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \mbox{\hyperlink{struct_command_router_1_1_route_entry_a5f8e8773587531b8d5dfe46e04bfbc1c}{name}};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00030}00030\ \ \ \ \ \};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00032}00032\ \ \ \ \ \textcolor{comment}{//\ Table\ of\ Routes}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00033}\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{00033}}\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_command_router_1_1_route_entry}{RouteEntry}}\ \mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}}[]\ =\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00034}00034\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9caa2cb872d6738be05568903e3cc0a0c77}{UnifiedCommandType::FilamentMotionShort}},\ \mbox{\hyperlink{namespace_control_logic_a5f85db884abd1a66d8b120729ec0d99e}{ControlLogic::ProcessMotionShort}},\ \textcolor{stringliteral}{"{}MotionShort"{}}\ \},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00035}00035\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca84ef06344d5159ac0d02201780d584be}{UnifiedCommandType::FilamentMotionLong}},\ \ \mbox{\hyperlink{namespace_control_logic_a2ab840bfd454a7709553b89529285b74}{ControlLogic::ProcessMotionLong}},\ \ \textcolor{stringliteral}{"{}MotionLong"{}}\ \ \},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00036}00036\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cadb5148c679935c8821fac8fad759922f}{UnifiedCommandType::OnlineDetect}},\ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a412a7a597ff3c04c0ea1480094600ef4}{ControlLogic::ProcessOnlineDetect}},\textcolor{stringliteral}{"{}OnlineDetect"{}}\},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00037}00037\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca403d48ab34ede926334f42e9f1e118b2}{UnifiedCommandType::REQx6}},\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a82b9a1fb120cd91615d2ac478daafefd}{ControlLogic::ProcessREQx6}},\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}REQx6"{}}\ \ \ \ \ \ \ \},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00038}00038\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cab72778b10468ded56d76c818eae14c76}{UnifiedCommandType::SetFilamentInfo}},\ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_ada1dd6f18fca06d8b26836f4788ab0ad}{ControlLogic::ProcessSetFilamentInfo}},\ \textcolor{stringliteral}{"{}SetFilament"{}}\ \},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00039}00039\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca83622997d22f5f18b9b09bd364cb673e}{UnifiedCommandType::Heartbeat}},\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a0c4206af909c8128bc68eb6a1bcfa16e}{ControlLogic::ProcessHeartbeat}},\ \ \ \textcolor{stringliteral}{"{}Heartbeat"{}}\ \ \ \},}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00040}00040\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Mapped\ Long\ Packets\ (Handler\ calls\ helper\ that\ parses\ long\ packet)}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00041}00041\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ CommandRouter::Route\ logic\ for\ these\ was\ effectively\ parsing\ long\ packet\ then\ calling\ ControlLogic::ProcessLongPacket}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00042}00042\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ make\ a\ helper\ in\ CommandRouter\ or\ ControlLogic.\ }}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Let's\ use\ a\ generic\ handler\ or\ specific\ wrapper\ if\ needed.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00044}00044\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ now,\ mapping\ to\ a\ specialized\ handler\ or\ generic\ one.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00045}00045\ \ \ \ \ \ \};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00047}\mbox{\hyperlink{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}{00047}}\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}{routeTableSize}}\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}})\ /\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{struct_command_router_1_1_route_entry}{RouteEntry}});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00048}00048\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00049}00049\ \ \ \ \ \textcolor{comment}{//\ -\/-\/-\/\ Long\ Packet\ Handlers\ Wrapper\ -\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00050}00050\ \ \ \ \ \textcolor{comment}{//\ Since\ ControlLogic::ProcessLongPacket\ expects\ parsed\ struct,\ we\ need\ a\ wrapper\ if\ we\ route\ raw\ buffer.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00051}00051\ \ \ \ \ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ TESTING\ */}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00061}\mbox{\hyperlink{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}{00061}}\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}{HandleLongPacket}}(uint8\_t*\ buffer,\ uint16\_t\ length)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00062}00062\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structlong__packge__data}{long\_packge\_data}}\ data;}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00063}00063\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_bambu_bus_protocol_ad0e11ad5c710644e9f1ee2fb4f15a3b9}{BambuBusProtocol::ParseLongPacket}}(buffer,\ length,\ \&data);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a1ff0bcee8062346fb963e4dd845c8bdf}{ControlLogic::ProcessLongPacket}}(data);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00065}00065\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00067}00067\ \ \ \ \ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ TESTING\ */}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00076}\mbox{\hyperlink{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e}{00076}}\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e}{Init}}(\textcolor{keywordtype}{bool}\ isKlipper)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Always\ Init\ BambuBus\ as\ it\ might\ be\ switched\ to?\ }}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00078}00078\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Or\ if\ not\ standard\ serial}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00079}00079\ \textcolor{preprocessor}{\#ifndef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00080}00080\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_bambu_bus_protocol_a0f26cda5df5c3a8882b7d371d44f6a5e}{BambuBusProtocol::Init}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00081}00081\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00082}00082\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00083}00083\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isKlipper)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00084}00084\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00085}00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00086}00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (SerialCLI::Accumulate(\textcolor{keywordtype}{byte}))\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00087}00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}*\ line\ =\ SerialCLI::GetInitBuffer();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00088}00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ len\ =\ SerialCLI::GetLength();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00089}00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (len\ <\ 1000)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ line,\ len);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00091}00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}}[len]\ =\ 0;\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00092}00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}}\ =\ len;\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00094}00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Reset();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00095}00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00096}00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00097}00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00098}00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Init();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00099}00099\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_a94936a207238747445fb8f43cdd4a2f4}{KlipperCLI::FeedByte}}(\textcolor{keywordtype}{byte});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00102}00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00103}00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_a5498861593ca8083d7be1d71c8373f29}{KlipperCLI::Init}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00104}00104\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00105}00105\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00106}00106\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Bus\ Mode}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00107}00107\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00108}00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{class_bambu_bus_protocol_af0a63f3d5cca52f48394c7129407e585}{BambuBusProtocol::ParseByte}}(\textcolor{keywordtype}{byte}))\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t*\ buffer\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_a8b2a47c616b38cef6c47c1d1b9c92411}{BambuBusProtocol::GetRxBuffer}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint16\_t\ length\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_ae7f742147d3316c118f4230a56a722bd}{BambuBusProtocol::GetRxLength}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00111}00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (length\ <\ 1000)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00112}00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ buffer,\ length);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00113}00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}}\ =\ length;}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00115}00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00116}00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00118}00118\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00119}00119\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00120}00120\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00121}00121\ \ \ \ \ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ TESTING\ */}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00133}\mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{00133}}\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}(\mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{UnifiedCommandType}}\ type,\ uint8\_t*\ buffer,\ uint16\_t\ length)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00134}00134\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Generic\ Connectivity\ Update}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00135}00135\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca6adf97f83acf6453d4a6a4b1070f3754}{UnifiedCommandType::None}}\ \&\&\ type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00137}00137\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (type\ ==\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00140}00140\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00141}00141\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00142}00142\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Table\ Lookup}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00143}00143\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ found\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00144}00144\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i=0;\ i<\mbox{\hyperlink{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}{routeTableSize}};\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}}[i].type\ ==\ type)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}}[i].handler(buffer,\ length);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ found\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00148}00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00150}00150\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00151}00151\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00152}00152\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!found)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Handle\ special\ Long\ Packet\ types\ that\ map\ to\ same\ logic?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ UnifiedCommandType\ for\ Long\ Packets:\ MCOnline,\ ReadFilamentInfo,\ etc.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ These\ all\ need\ parsing\ via\ ParseLongPacket.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ add\ them\ to\ table\ pointing\ to\ HandleLongPacket\ wrapper.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(type)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cab243c306036d0eec5691b5629d15f024}{UnifiedCommandType::MCOnline}}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca2c0ccc43448d5e1e8576ab6bc582e2fb}{UnifiedCommandType::ReadFilamentInfo}}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00160}00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca182645fd81a6683f911479f84a15e46d}{UnifiedCommandType::SetFilamentInfoType2}}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00161}00161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca34b6cd75171affba6957e308dcbd92be}{UnifiedCommandType::Version}}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00162}00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9caa54372ef430f726c8343fc5550fade42}{UnifiedCommandType::SerialNumber}}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca84ef06344d5159ac0d02201780d584be}{UnifiedCommandType::FilamentMotionLong}}:\ \textcolor{comment}{//\ Also\ a\ long\ packet}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}{HandleLongPacket}}(buffer,\ length);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00169}00169\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00170}00170\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00171}00171\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00172}00172\ \ \ \ \ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ TESTING\ */}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00180}\mbox{\hyperlink{namespace_command_router_a96ff3718682e9322a64815a3d41d001b}{00180}}\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespace_command_router_a96ff3718682e9322a64815a3d41d001b}{Run}}()\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00181}00181\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_control_logic_a300e5b18ebf53c086955bf02dfe16faa}{ControlLogic::GetBootMode}}()\ ==\ \mbox{\hyperlink{namespace_control_logic_aa23e295fa5022b6569547cf94f091070a6de97d301a2cd910140aca79b2b50a55}{ControlLogic::BootMode::Klipper}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00182}00182\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Polling\ if\ needed?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00184}00184\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00185}00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_afe96c8a3898aa7a50f68ab6d726860c3}{KlipperCLI::Run}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00186}00186\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00187}00187\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00188}00188\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00189}00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00190}00190\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{false};\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00191}00191\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00192}00192\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_control_logic_a300e5b18ebf53c086955bf02dfe16faa}{ControlLogic::GetBootMode}}()\ ==\ \mbox{\hyperlink{namespace_control_logic_aa23e295fa5022b6569547cf94f091070a6de97d301a2cd910140aca79b2b50a55}{ControlLogic::BootMode::Klipper}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00193}00193\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00194}00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Parse((\textcolor{keywordtype}{char}*)\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00195}00195\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#else}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_afe96c8a3898aa7a50f68ab6d726860c3}{KlipperCLI::Run}}();\ \textcolor{comment}{//\ KlipperCLI\ processes\ its\ own\ buffer\ usually,\ but\ verify?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Actually\ KlipperCLI::Run\ handles\ feeding\ from\ buffer\ if\ using\ FeedByte?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ callback\ calls\ FeedByte.\ }}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00199}00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ process\_ready\ logic\ is\ for\ PACKET\ extraction.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ KlipperCLI,\ process\_ready\ is\ not\ used\ if\ we\ feed\ directly\ in\ callback?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ Init\ callback\ calls\ FeedByte\ directly.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00202}00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ So\ process\_ready\ is\ NOT\ set\ for\ KlipperCLI.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00203}00203\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ for\ SerialCLI\ it\ IS\ set.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00204}00204\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Bus\ Mode}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad269fd29299dd87118b408e4551f4d2d}{Hardware::DelayMS}}(1);\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00208}00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_bambu_bus_protocol_8h_a28b188362482dd49915e0f8c5cce1ac5}{BambuBus\_package\_type}}\ bb\_type\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_a81deddd553eeb25fa96580079d7c9bd0}{BambuBusProtocol::IdentifyPacket}}(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00209}00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{UnifiedCommandType}}\ unified\_type\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_addece07a1980f5f561e151fd4a09b9ea}{BambuBusProtocol::GetUnifiedType}}(bb\_type);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00210}00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00211}00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unified\_type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca6adf97f83acf6453d4a6a4b1070f3754}{UnifiedCommandType::None}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00212}00212\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\_packet\_time}}\ =\ \mbox{\hyperlink{namespace_hardware_a8ea28b07408691bc126683a81aa220f3}{Hardware::GetTime}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00213}00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}(unified\_type,\ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (bb\_type\ ==\ \mbox{\hyperlink{_bambu_bus_protocol_8h_a28b188362482dd49915e0f8c5cce1ac5abb1ca97ec761fc37101737ba0aa2e7c5}{BambuBus\_package\_type::ERROR}})\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}(\mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}},\ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00218}00218\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00219}00219\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00220}00220\ \ \ \ \ \ \ \ \ uint64\_t\ now\ =\ \mbox{\hyperlink{namespace_hardware_a8ea28b07408691bc126683a81aa220f3}{Hardware::GetTime}}();}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00221}00221\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now\ -\/\ \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\_packet\_time}}\ >\ 3000)\ \{\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00223}00223\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00224}00224\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00225}00225\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00226}00226\ \ \ \ \ \textcolor{comment}{//\ Helper\ to\ send\ packet\ (Abstraction\ for\ Hardware)}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00227}00227\ \ \ \ \ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ TESTING\ */}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00234}\mbox{\hyperlink{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d}{00234}}\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d}{SendPacket}}(uint8\_t\ *data,\ uint16\_t\ length)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00235}00235\ \textcolor{preprocessor}{\#ifdef\ STANDARD\_SERIAL}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00236}00236\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ StandardSerial,\ we\ might\ want\ to\ print\ Debug\ Hex\ IF\ configured,\ }}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00237}00237\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ OR\ we\ might\ want\ to\ convert\ the\ binary\ response\ to\ a\ human\ readable\ response?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00238}00238\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ ControlLogic\ generated\ a\ binary\ packet\ response.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00239}00239\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ SerialCLI,\ we\ probably\ want\ to\ intercept\ this\ and\ print\ text.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00240}00240\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ since\ we\ are\ refactoring,\ \`{}SerialCLI`\ should\ handle\ responses\ itself?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00241}00241\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ However,\ \`{}ControlLogic`\ calls\ \`{}CommandRouter::SendPacket`.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00242}00242\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ So\ we\ interpret\ it\ here.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00243}00243\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00244}00244\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ Decode\ packet\ and\ print\ text?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00245}00245\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reuse\ DecodeAndPrintPacket\ logic\ from\ previous\ version\ or\ simplify?}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00246}00246\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ now,\ let's\ just\ print\ a\ "{}TxPacket"{}\ debug\ line\ so\ we\ see\ what\ logic\ sent.}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00247}00247\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00248}00248\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ prefix\ =\ \textcolor{stringliteral}{"{}[TX]\ "{}};}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00249}00249\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)prefix,\ 5);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00250}00250\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(uint16\_t\ i=0;\ i<length;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00251}00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ tmp[4];}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00252}00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ sprintf(tmp,\ \textcolor{stringliteral}{"{}\%02X\ "{}},\ data[i]);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00253}00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)tmp,\ strlen(tmp));}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00254}00254\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00255}00255\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)\textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}},\ 2);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00256}00256\ }
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00257}00257\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00258}00258\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}(data,\ length);}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00259}00259\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00260}00260\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_command_router_8cpp_source_l00261}00261\ \}}

\end{DoxyCode}
