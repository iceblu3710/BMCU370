\doxysection{Flash\+\_\+saves.\+cpp}
\hypertarget{_flash__saves_8cpp_source}{}\label{_flash__saves_8cpp_source}\index{src/Flash\_saves.cpp@{src/Flash\_saves.cpp}}
\mbox{\hyperlink{_flash__saves_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00002}00002\ \textcolor{comment}{*\ DEVELOPMENT\ STATE:\ FUNCTIONAL}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00003}00003\ \textcolor{comment}{*\ PROVEN\ FUNCTIONAL\ -\/\ DO\ NOT\ MODIFY}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00004}00004\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00005}00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_flash__saves_8h}{Flash\_saves.h}}"{}}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00007}00007\ \textcolor{comment}{/*\ Global\ define\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00008}\mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3}{00008}}\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{enum}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00009}00009\ \{}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00010}\mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3aecedb56d1405a60c6069f4a0139bdec5}{00010}}\ \ \ \ \ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3aecedb56d1405a60c6069f4a0139bdec5}{FAILED}}\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00011}\mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3a9e1b634c4e09fb9309c8e242fa8d0413}{00011}}\ \ \ \ \ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3a9e1b634c4e09fb9309c8e242fa8d0413}{PASSED}}\ =\ !\mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3aecedb56d1405a60c6069f4a0139bdec5}{FAILED}}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00012}00012\ \}\ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3}{TestStatus}};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00013}00013\ \textcolor{comment}{//\ \#define\ PAGE\_WRITE\_START\_ADDR\ ((uint32\_t)0x08008000)\ /*\ Start\ from\ 32K\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00014}00014\ \textcolor{comment}{//\ \#define\ PAGE\_WRITE\_END\_ADDR\ ((uint32\_t)0x08009000)\ \ \ /*\ End\ at\ 36K\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00015}\mbox{\hyperlink{_flash__saves_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{00015}}\ \textcolor{preprocessor}{\#define\ FLASH\_PAGE\_SIZE\ 4096}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00016}\mbox{\hyperlink{_flash__saves_8cpp_af64545d7003828a8fee9a117f35def75}{00016}}\ \textcolor{preprocessor}{\#define\ FLASH\_PAGES\_TO\_BE\_PROTECTED\ FLASH\_WRProt\_Pages60to63}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00018}00018\ \textcolor{comment}{/*\ Global\ Variable\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00019}\mbox{\hyperlink{_flash__saves_8cpp_aca1b23fd721c8d8dc70a8227e336b6e8}{00019}}\ uint32\_t\ \mbox{\hyperlink{_flash__saves_8cpp_a542f51e3b9830b051fb184bd1d4aba3b}{EraseCounter}}\ =\ 0x0,\ \mbox{\hyperlink{_flash__saves_8cpp_aca1b23fd721c8d8dc70a8227e336b6e8}{Address}}\ =\ 0x0;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00020}\mbox{\hyperlink{_flash__saves_8cpp_af75ea13d281210e54c4d4c09ea42b1df}{00020}}\ uint16\_t\ \mbox{\hyperlink{_flash__saves_8cpp_af75ea13d281210e54c4d4c09ea42b1df}{Data}}\ =\ 0xAAAA;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00021}\mbox{\hyperlink{_flash__saves_8cpp_ad7174ff3205a6ad925bb3606d52a460f}{00021}}\ uint32\_t\ \mbox{\hyperlink{_flash__saves_8cpp_a1f0eb0802e889faff365f4cbb26b6ad4}{WRPR\_Value}}\ =\ 0xFFFFFFFF,\ \mbox{\hyperlink{_flash__saves_8cpp_ad7174ff3205a6ad925bb3606d52a460f}{ProtectedPages}}\ =\ 0x0;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00023}\mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{00023}}\ \textcolor{keyword}{volatile}\ FLASH\_Status\ \mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ =\ FLASH\_COMPLETE;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00024}\mbox{\hyperlink{_flash__saves_8cpp_a37d6f9f37a1da95f5ddf3dc06cc37297}{00024}}\ \textcolor{keyword}{volatile}\ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3}{TestStatus}}\ \mbox{\hyperlink{_flash__saves_8cpp_a37d6f9f37a1da95f5ddf3dc06cc37297}{MemoryProgramStatus}}\ =\ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3a9e1b634c4e09fb9309c8e242fa8d0413}{PASSED}};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00025}\mbox{\hyperlink{_flash__saves_8cpp_a84bd3cc81eb5ff23757e6c72fbc75058}{00025}}\ \textcolor{keyword}{volatile}\ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3}{TestStatus}}\ \mbox{\hyperlink{_flash__saves_8cpp_a84bd3cc81eb5ff23757e6c72fbc75058}{MemoryEraseStatus}}\ =\ \mbox{\hyperlink{_flash__saves_8cpp_af150c85f3da4e3fb41d83d4a465f7fc3a9e1b634c4e09fb9309c8e242fa8d0413}{PASSED}};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00027}\mbox{\hyperlink{_flash__saves_8cpp_ae6a106fb7cef368880ae52d337bfbcf4}{00027}}\ \textcolor{preprocessor}{\#define\ Fadr\ (0x08020000)}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00028}\mbox{\hyperlink{_flash__saves_8cpp_ab32416b00f76835bddf14b9c61760687}{00028}}\ \textcolor{preprocessor}{\#define\ Fsize\ ((((256\ *\ 4))\ >>\ 2))}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00029}\mbox{\hyperlink{_flash__saves_8cpp_a9364481806e5ccb7d6cb2113b1b7a2d5}{00029}}\ u32\ \mbox{\hyperlink{_flash__saves_8cpp_a9364481806e5ccb7d6cb2113b1b7a2d5}{buf}}[\mbox{\hyperlink{_flash__saves_8cpp_ab32416b00f76835bddf14b9c61760687}{Fsize}}];}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00031}00031\ \textcolor{comment}{/*********************************************************************}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00032}00032\ \textcolor{comment}{\ *\ @fn\ \ \ \ \ \ Flash\_Test}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00033}00033\ \textcolor{comment}{\ *}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00034}00034\ \textcolor{comment}{\ *\ @brief\ \ \ Flash\ Program\ Test.}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00035}00035\ \textcolor{comment}{\ *}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00036}00036\ \textcolor{comment}{\ *\ @return\ \ none}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00037}00037\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00038}00038\ \textcolor{comment}{/*\ DEVELOPMENT\ STATE:\ FUNCTIONAL\ */}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00051}\mbox{\hyperlink{_flash__saves_8cpp_ae5951341b70b0da0d768d418bfcb76ce}{00051}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{_flash__saves_8cpp_ae5951341b70b0da0d768d418bfcb76ce}{Flash\_saves}}(\textcolor{keywordtype}{void}\ *\mbox{\hyperlink{_flash__saves_8cpp_a9364481806e5ccb7d6cb2113b1b7a2d5}{buf}},\ uint32\_t\ length,\ uint32\_t\ address)}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00052}00052\ \{}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00053}00053\ \ \ \ \ uint32\_t\ end\_address\ =\ address\ +\ length;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00054}00054\ \ \ \ \ uint32\_t\ erase\_counter\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00055}00055\ \ \ \ \ uint32\_t\ address\_i\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00056}00056\ \ \ \ \ uint32\_t\ page\_num\ =\ (length\ +\ \mbox{\hyperlink{_flash__saves_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}}\ -\/\ 1)\ /\ \mbox{\hyperlink{_flash__saves_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00057}00057\ \ \ \ \ \textcolor{keywordflow}{if}\ (page\_num\ ==\ 0)\ page\_num\ =\ 1;\ \textcolor{comment}{//\ Safety}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00058}00058\ \ \ \ \ uint16\_t\ *data\_ptr\ =\ (uint16\_t\ *)\mbox{\hyperlink{_flash__saves_8cpp_a9364481806e5ccb7d6cb2113b1b7a2d5}{buf}};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00060}00060\ \ \ \ \ \_\_disable\_irq();\ \textcolor{comment}{//\ 禁用中断}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00061}00061\ \ \ \ \ FLASH\_Unlock();}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00063}00063\ \ \ \ \ FLASH\_ClearFlag(FLASH\_FLAG\_BSY\ |\ FLASH\_FLAG\_EOP\ |\ FLASH\_FLAG\_WRPRTERR);}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00064}00064\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00065}00065\ \ \ \ \ \textcolor{keywordflow}{for}\ (erase\_counter\ =\ 0;\ (erase\_counter\ <\ page\_num)\ \&\&\ (\mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ ==\ FLASH\_COMPLETE);\ erase\_counter++)}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00066}00066\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00067}00067\ \ \ \ \ \ \ \ \ IWDG-\/>CTLR\ =\ 0xAAAA;\ \textcolor{comment}{//\ Reload\ IWDG}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00068}00068\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ =\ FLASH\_ErasePage(address\ +\ (\mbox{\hyperlink{_flash__saves_8cpp_a4cc14e2c99ae7f8e5a8e371d03c8532c}{FLASH\_PAGE\_SIZE}}\ *\ erase\_counter));\ \textcolor{comment}{//\ Erase\ 4KB}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00069}00069\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00070}00070\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ !=\ FLASH\_COMPLETE)}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00071}00071\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ FLASH\_Lock();}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ \_\_enable\_irq();}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00074}00074\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00075}00075\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00076}00076\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00078}00078\ \ \ \ \ address\_i\ =\ address;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00079}00079\ \ \ \ \ \textcolor{keywordflow}{while}\ ((address\_i\ <\ end\_address)\ \&\&\ (\mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ ==\ FLASH\_COMPLETE))}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00080}00080\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00081}00081\ \ \ \ \ \ \ \ \ IWDG-\/>CTLR\ =\ 0xAAAA;\ \textcolor{comment}{//\ Reload\ IWDG\ during\ long\ writes}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00082}00082\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ =\ FLASH\_ProgramHalfWord(address\_i,\ *data\_ptr);}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00083}00083\ \ \ \ \ \ \ \ \ address\_i\ =\ address\_i\ +\ 2;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00084}00084\ \ \ \ \ \ \ \ \ data\_ptr++;}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00085}00085\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00086}00086\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00087}00087\ \ \ \ \ FLASH\_Lock();}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00088}00088\ \ \ \ \ \_\_enable\_irq();}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00089}00089\ }
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00090}00090\ \ \ \ \ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{_flash__saves_8cpp_afe85d42720512872050ce14f37857da1}{FLASHStatus}}\ ==\ FLASH\_COMPLETE);}
\DoxyCodeLine{\Hypertarget{_flash__saves_8cpp_source_l00091}00091\ \}}

\end{DoxyCode}
