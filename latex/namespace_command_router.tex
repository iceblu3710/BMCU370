\doxysection{Command\+Router Namespace Reference}
\hypertarget{namespace_command_router}{}\label{namespace_command_router}\index{CommandRouter@{CommandRouter}}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{struct_command_router_1_1_route_entry}{Route\+Entry}}
\end{DoxyCompactItemize}
\doxysubsubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef void(\texorpdfstring{$\ast$}{*} \mbox{\hyperlink{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1}{Packet\+Handler}}) (uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, uint16\+\_\+t length)
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}{Handle\+Long\+Packet}} (uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, uint16\+\_\+t length)
\begin{DoxyCompactList}\small\item\em wrapper to handle Long Packets by parsing and dispatching. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e}{Init}} (bool is\+Klipper)
\begin{DoxyCompactList}\small\item\em Initialize the Command Router and CLI subsystems. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}} (\mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{Unified\+Command\+Type}} type, uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, uint16\+\_\+t length)
\begin{DoxyCompactList}\small\item\em Route an incoming command to its specific handler. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{namespace_command_router_a96ff3718682e9322a64815a3d41d001b}{Run}} ()
\begin{DoxyCompactList}\small\item\em Main execution loop for the Router. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d}{Send\+Packet}} (uint8\+\_\+t \texorpdfstring{$\ast$}{*}data, uint16\+\_\+t length)
\begin{DoxyCompactList}\small\item\em Send a raw data packet via UART. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static uint64\+\_\+t \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\+\_\+packet\+\_\+time}} = 0
\item 
static uint8\+\_\+t \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\+\_\+buffer}} \mbox{[}1024\mbox{]}
\item 
static volatile uint16\+\_\+t \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\+\_\+len}} = 0
\item 
static volatile bool \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\+\_\+ready}} = false
\item 
static const \mbox{\hyperlink{struct_command_router_1_1_route_entry}{Route\+Entry}} \mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{route\+Table}} \mbox{[}$\,$\mbox{]}
\item 
static const int \mbox{\hyperlink{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}{route\+Table\+Size}} = sizeof(\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{route\+Table}}) / sizeof(\mbox{\hyperlink{struct_command_router_1_1_route_entry}{Route\+Entry}})
\end{DoxyCompactItemize}


\label{doc-typedef-members}
\Hypertarget{namespace_command_router_doc-typedef-members}
\doxysubsection{Typedef Documentation}
\Hypertarget{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1}\index{CommandRouter@{CommandRouter}!PacketHandler@{PacketHandler}}
\index{PacketHandler@{PacketHandler}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{PacketHandler}{PacketHandler}}
{\footnotesize\ttfamily \label{namespace_command_router_a18c518e4016d268b1b1410b094d83cb1} 
typedef void(\texorpdfstring{$\ast$}{*} Command\+Router\+::\+Packet\+Handler) (uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, uint16\+\_\+t length)}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00024}{24}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



\label{doc-func-members}
\Hypertarget{namespace_command_router_doc-func-members}
\doxysubsection{Function Documentation}
\Hypertarget{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}\index{CommandRouter@{CommandRouter}!HandleLongPacket@{HandleLongPacket}}
\index{HandleLongPacket@{HandleLongPacket}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{HandleLongPacket()}{HandleLongPacket()}}
{\footnotesize\ttfamily \label{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21} 
void Command\+Router\+::\+Handle\+Long\+Packet (\begin{DoxyParamCaption}\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{buffer}{, }\item[{uint16\+\_\+t}]{length}{}\end{DoxyParamCaption})}



wrapper to handle Long Packets by parsing and dispatching. 

Parses the raw buffer into a {\ttfamily \doxylink{structlong__packge__data}{long\+\_\+packge\+\_\+data}} struct and passes it to {\ttfamily \doxylink{namespace_control_logic_a1ff0bcee8062346fb963e4dd845c8bdf}{Control\+Logic\+::\+Process\+Long\+Packet}}.


\begin{DoxyParams}{Parameters}
{\em buffer} & Raw packet buffer. \\
\hline
{\em length} & Length of the packet. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00061}{61}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structlong__packge__data}{long\_packge\_data}}\ data;}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_bambu_bus_protocol_ad0e11ad5c710644e9f1ee2fb4f15a3b9}{BambuBusProtocol::ParseLongPacket}}(buffer,\ length,\ \&data);}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a1ff0bcee8062346fb963e4dd845c8bdf}{ControlLogic::ProcessLongPacket}}(data);}
\DoxyCodeLine{00065\ \ \ \ \ \}}

\end{DoxyCode}


References \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00214}{Bambu\+Bus\+Protocol\+::\+Parse\+Long\+Packet()}}, and \mbox{\hyperlink{_control_logic_8cpp_source_l01435}{Control\+Logic\+::\+Process\+Long\+Packet()}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00133}{Route()}}.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21_icgraph}
\end{center}
\end{figure}
\Hypertarget{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e}\index{CommandRouter@{CommandRouter}!Init@{Init}}
\index{Init@{Init}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{Init()}{Init()}}
{\footnotesize\ttfamily \label{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e} 
void Command\+Router\+::\+Init (\begin{DoxyParamCaption}\item[{bool}]{is\+Klipper}{}\end{DoxyParamCaption})}



Initialize the Command Router and CLI subsystems. 

Sets up the UART Rx callbacks based on the boot mode (Klipper vs Bus). Initializes the appropriate CLI or Protocol handler.


\begin{DoxyParams}{Parameters}
{\em is\+Klipper} & True if booting into Klipper mode, False for Bambu\+Bus mode. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00076}{76}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Always\ Init\ BambuBus\ as\ it\ might\ be\ switched\ to?\ }}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Or\ if\ not\ standard\ serial}}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#ifndef\ STANDARD\_SERIAL }}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_bambu_bus_protocol_a0f26cda5df5c3a8882b7d371d44f6a5e}{BambuBusProtocol::Init}}();}
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#endif }}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isKlipper)\ \{}
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL }}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (SerialCLI::Accumulate(\textcolor{keywordtype}{byte}))\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}*\ line\ =\ SerialCLI::GetInitBuffer();}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ len\ =\ SerialCLI::GetLength();}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (len\ <\ 1000)\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ line,\ len);}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}}[len]\ =\ 0;\ }
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}}\ =\ len;\ }
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Reset();}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Init();}
\DoxyCodeLine{00099\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#else }}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_a94936a207238747445fb8f43cdd4a2f4}{KlipperCLI::FeedByte}}(\textcolor{keywordtype}{byte});}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_a5498861593ca8083d7be1d71c8373f29}{KlipperCLI::Init}}();}
\DoxyCodeLine{00104\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif }}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Bus\ Mode}}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_a8eaf73ad39643f6bb1bbe74d9b5e8b86}{Hardware::UART\_SetRxCallback}}([](uint8\_t\ \textcolor{keywordtype}{byte})\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{class_bambu_bus_protocol_af0a63f3d5cca52f48394c7129407e585}{BambuBusProtocol::ParseByte}}(\textcolor{keywordtype}{byte}))\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t*\ buffer\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_a8b2a47c616b38cef6c47c1d1b9c92411}{BambuBusProtocol::GetRxBuffer}}();}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint16\_t\ length\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_ae7f742147d3316c118f4230a56a722bd}{BambuBusProtocol::GetRxLength}}();}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (length\ <\ 1000)\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ buffer,\ length);}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}}\ =\ length;}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00119\ \ \ \ \ \}}

\end{DoxyCode}


References \mbox{\hyperlink{_klipper_c_l_i_8cpp_source_l00467}{Klipper\+CLI\+::\+Feed\+Byte()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00116}{Bambu\+Bus\+Protocol\+::\+Get\+Rx\+Buffer()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00126}{Bambu\+Bus\+Protocol\+::\+Get\+Rx\+Length()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00024}{Bambu\+Bus\+Protocol\+::\+Init()}}, \mbox{\hyperlink{_klipper_c_l_i_8cpp_source_l00439}{Klipper\+CLI\+::\+Init()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00041}{Bambu\+Bus\+Protocol\+::\+Parse\+Byte()}}, \mbox{\hyperlink{_command_router_8cpp_source_l00019}{process\+\_\+buffer}}, \mbox{\hyperlink{_command_router_8cpp_source_l00020}{process\+\_\+len}}, \mbox{\hyperlink{_command_router_8cpp_source_l00021}{process\+\_\+ready}}, and \mbox{\hyperlink{_hardware_8cpp_source_l00128}{Hardware\+::\+UART\+\_\+\+Set\+Rx\+Callback()}}.



Referenced by \mbox{\hyperlink{main_8cpp_source_l00013}{setup()}}.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=266pt]{namespace_command_router_a652cfc164ac7a2a2c016da37f341c42e_icgraph}
\end{center}
\end{figure}
\Hypertarget{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}\index{CommandRouter@{CommandRouter}!Route@{Route}}
\index{Route@{Route}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{Route()}{Route()}}
{\footnotesize\ttfamily \label{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b} 
void Command\+Router\+::\+Route (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{Unified\+Command\+Type}}}]{type}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{buffer}{, }\item[{uint16\+\_\+t}]{length}{}\end{DoxyParamCaption})}



Route an incoming command to its specific handler. 

Updates connectivity status and dispatches the command based on {\ttfamily type}. Uses a table lookup for common commands and a switch case for special Long Packet handling.


\begin{DoxyParams}{Parameters}
{\em type} & The Unified Command Type. \\
\hline
{\em buffer} & Pointer to the command data. \\
\hline
{\em length} & Length of the command data. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00133}{133}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Generic\ Connectivity\ Update}}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca6adf97f83acf6453d4a6a4b1070f3754}{UnifiedCommandType::None}}\ \&\&\ type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}})\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (type\ ==\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}})\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{false});}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};\ }
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Table\ Lookup}}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ found\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i=0;\ i<\mbox{\hyperlink{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}{routeTableSize}};\ i++)\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}}[i].type\ ==\ type)\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{routeTable}}[i].handler(buffer,\ length);}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ found\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!found)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Handle\ special\ Long\ Packet\ types\ that\ map\ to\ same\ logic?}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ UnifiedCommandType\ for\ Long\ Packets:\ MCOnline,\ ReadFilamentInfo,\ etc.}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ These\ all\ need\ parsing\ via\ ParseLongPacket.}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ add\ them\ to\ table\ pointing\ to\ HandleLongPacket\ wrapper.}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(type)\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cab243c306036d0eec5691b5629d15f024}{UnifiedCommandType::MCOnline}}:}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca2c0ccc43448d5e1e8576ab6bc582e2fb}{UnifiedCommandType::ReadFilamentInfo}}:}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca182645fd81a6683f911479f84a15e46d}{UnifiedCommandType::SetFilamentInfoType2}}:}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca34b6cd75171affba6957e308dcbd92be}{UnifiedCommandType::Version}}:}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9caa54372ef430f726c8343fc5550fade42}{UnifiedCommandType::SerialNumber}}:}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca84ef06344d5159ac0d02201780d584be}{UnifiedCommandType::FilamentMotionLong}}:\ \textcolor{comment}{//\ Also\ a\ long\ packet}}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a1d2e53549b25a63274ad073b375e5f21}{HandleLongPacket}}(buffer,\ length);}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00170\ \ \ \ \ \}}

\end{DoxyCode}


References \mbox{\hyperlink{_command_types_8h_source_l00019}{Error}}, \mbox{\hyperlink{_command_types_8h_source_l00008}{Filament\+Motion\+Long}}, \mbox{\hyperlink{_command_router_8cpp_source_l00061}{Handle\+Long\+Packet()}}, \mbox{\hyperlink{_command_types_8h_source_l00013}{MCOnline}}, \mbox{\hyperlink{_command_types_8h_source_l00006}{None}}, \mbox{\hyperlink{_command_types_8h_source_l00014}{Read\+Filament\+Info}}, \mbox{\hyperlink{_command_router_8cpp_source_l00033}{route\+Table}}, \mbox{\hyperlink{_command_router_8cpp_source_l00047}{route\+Table\+Size}}, \mbox{\hyperlink{_command_types_8h_source_l00017}{Serial\+Number}}, \mbox{\hyperlink{_command_types_8h_source_l00015}{Set\+Filament\+Info\+Type2}}, \mbox{\hyperlink{_control_logic_8cpp_source_l00948}{Control\+Logic\+::\+Update\+Connectivity()}}, and \mbox{\hyperlink{_command_types_8h_source_l00016}{Version}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00180}{Run()}}.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b_icgraph}
\end{center}
\end{figure}
\Hypertarget{namespace_command_router_a96ff3718682e9322a64815a3d41d001b}\index{CommandRouter@{CommandRouter}!Run@{Run}}
\index{Run@{Run}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{Run()}{Run()}}
{\footnotesize\ttfamily \label{namespace_command_router_a96ff3718682e9322a64815a3d41d001b} 
void Command\+Router\+::\+Run (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Main execution loop for the Router. 

Checks for new packets from the underlying protocol (Serial\+CLI, \doxylink{namespace_klipper_c_l_i}{Klipper\+CLI}, or Bambu\+Bus). If a packet is ready, it identifies the type (if Bus mode) and calls {\ttfamily \doxylink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}. Also manages the "{}\+Offline"{} timeout logic (3 seconds). 

Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00180}{180}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_control_logic_a300e5b18ebf53c086955bf02dfe16faa}{ControlLogic::GetBootMode}}()\ ==\ \mbox{\hyperlink{namespace_control_logic_aa23e295fa5022b6569547cf94f091070a6de97d301a2cd910140aca79b2b50a55}{ControlLogic::BootMode::Klipper}})\ \{}
\DoxyCodeLine{00182\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL }}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Polling\ if\ needed?}}
\DoxyCodeLine{00184\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#else }}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_afe96c8a3898aa7a50f68ab6d726860c3}{KlipperCLI::Run}}();}
\DoxyCodeLine{00186\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \#endif }}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}})\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}{process\_ready}}\ =\ \textcolor{keyword}{false};\ }
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespace_control_logic_a300e5b18ebf53c086955bf02dfe16faa}{ControlLogic::GetBootMode}}()\ ==\ \mbox{\hyperlink{namespace_control_logic_aa23e295fa5022b6569547cf94f091070a6de97d301a2cd910140aca79b2b50a55}{ControlLogic::BootMode::Klipper}})\ \{}
\DoxyCodeLine{00193\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#ifdef\ STANDARD\_SERIAL }}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ SerialCLI::Parse((\textcolor{keywordtype}{char}*)\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}});}
\DoxyCodeLine{00195\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#else }}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_klipper_c_l_i_afe96c8a3898aa7a50f68ab6d726860c3}{KlipperCLI::Run}}();\ \textcolor{comment}{//\ KlipperCLI\ processes\ its\ own\ buffer\ usually,\ but\ verify?}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Actually\ KlipperCLI::Run\ handles\ feeding\ from\ buffer\ if\ using\ FeedByte?}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ callback\ calls\ FeedByte.\ }}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ process\_ready\ logic\ is\ for\ PACKET\ extraction.}}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ KlipperCLI,\ process\_ready\ is\ not\ used\ if\ we\ feed\ directly\ in\ callback?}}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ Init\ callback\ calls\ FeedByte\ directly.}}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ So\ process\_ready\ is\ NOT\ set\ for\ KlipperCLI.}}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ for\ SerialCLI\ it\ IS\ set.}}
\DoxyCodeLine{00204\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \#endif }}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Bus\ Mode}}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad269fd29299dd87118b408e4551f4d2d}{Hardware::DelayMS}}(1);\ }
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_bambu_bus_protocol_8h_a28b188362482dd49915e0f8c5cce1ac5}{BambuBus\_package\_type}}\ bb\_type\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_a81deddd553eeb25fa96580079d7c9bd0}{BambuBusProtocol::IdentifyPacket}}(\mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9c}{UnifiedCommandType}}\ unified\_type\ =\ \mbox{\hyperlink{class_bambu_bus_protocol_addece07a1980f5f561e151fd4a09b9ea}{BambuBusProtocol::GetUnifiedType}}(bb\_type);}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unified\_type\ !=\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca6adf97f83acf6453d4a6a4b1070f3754}{UnifiedCommandType::None}})\ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\_packet\_time}}\ =\ \mbox{\hyperlink{namespace_hardware_a8ea28b07408691bc126683a81aa220f3}{Hardware::GetTime}}();}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}(unified\_type,\ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (bb\_type\ ==\ \mbox{\hyperlink{_bambu_bus_protocol_8h_a28b188362482dd49915e0f8c5cce1ac5abb1ca97ec761fc37101737ba0aa2e7c5}{BambuBus\_package\_type::ERROR}})\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_command_router_a329f0a7e2f53debf5c7cb5f47579151b}{Route}}(\mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca902b0d55fddef6f8d651fe1035b7d4bd}{UnifiedCommandType::Error}},\ \mbox{\hyperlink{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}{process\_buffer}},\ \mbox{\hyperlink{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}{process\_len}});}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ uint64\_t\ now\ =\ \mbox{\hyperlink{namespace_hardware_a8ea28b07408691bc126683a81aa220f3}{Hardware::GetTime}}();}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now\ -\/\ \mbox{\hyperlink{namespace_command_router_a094713e616919d86425f209582f1af2c}{last\_packet\_time}}\ >\ 3000)\ \{\ }
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a9716be5fe9da72481bee41a80681d8e5}{ControlLogic::UpdateConnectivity}}(\textcolor{keyword}{false});}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00224\ \ \ \ \ \}}

\end{DoxyCode}


References \mbox{\hyperlink{_hardware_8cpp_source_l00105}{Hardware\+::\+Delay\+MS()}}, \mbox{\hyperlink{_bambu_bus_protocol_8h_source_l00026}{ERROR}}, \mbox{\hyperlink{_command_types_8h_source_l00019}{Error}}, \mbox{\hyperlink{_control_logic_8cpp_source_l00936}{Control\+Logic\+::\+Get\+Boot\+Mode()}}, \mbox{\hyperlink{_hardware_8cpp_source_l00115}{Hardware\+::\+Get\+Time()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00305}{Bambu\+Bus\+Protocol\+::\+Get\+Unified\+Type()}}, \mbox{\hyperlink{_bambu_bus_protocol_8cpp_source_l00167}{Bambu\+Bus\+Protocol\+::\+Identify\+Packet()}}, \mbox{\hyperlink{_control_logic_8h_source_l00016}{Control\+Logic\+::\+Klipper}}, \mbox{\hyperlink{_command_router_8cpp_source_l00018}{last\+\_\+packet\+\_\+time}}, \mbox{\hyperlink{_command_types_8h_source_l00006}{None}}, \mbox{\hyperlink{_command_router_8cpp_source_l00019}{process\+\_\+buffer}}, \mbox{\hyperlink{_command_router_8cpp_source_l00020}{process\+\_\+len}}, \mbox{\hyperlink{_command_router_8cpp_source_l00021}{process\+\_\+ready}}, \mbox{\hyperlink{_command_router_8cpp_source_l00133}{Route()}}, \mbox{\hyperlink{_klipper_c_l_i_8cpp_source_l00449}{Klipper\+CLI\+::\+Run()}}, and \mbox{\hyperlink{_control_logic_8cpp_source_l00948}{Control\+Logic\+::\+Update\+Connectivity()}}.



Referenced by \mbox{\hyperlink{main_8cpp_source_l00040}{loop()}}.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a96ff3718682e9322a64815a3d41d001b_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a96ff3718682e9322a64815a3d41d001b_icgraph}
\end{center}
\end{figure}
\Hypertarget{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d}\index{CommandRouter@{CommandRouter}!SendPacket@{SendPacket}}
\index{SendPacket@{SendPacket}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{SendPacket()}{SendPacket()}}
{\footnotesize\ttfamily \label{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d} 
void Command\+Router\+::\+Send\+Packet (\begin{DoxyParamCaption}\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{data}{, }\item[{uint16\+\_\+t}]{length}{}\end{DoxyParamCaption})}



Send a raw data packet via UART. 


\begin{DoxyParams}{Parameters}
{\em data} & Pointer to data to send. \\
\hline
{\em length} & Length of data. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00234}{234}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00235\ \textcolor{preprocessor}{\#ifdef\ STANDARD\_SERIAL }}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ StandardSerial,\ we\ might\ want\ to\ print\ Debug\ Hex\ IF\ configured,\ }}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ OR\ we\ might\ want\ to\ convert\ the\ binary\ response\ to\ a\ human\ readable\ response?}}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ ControlLogic\ generated\ a\ binary\ packet\ response.}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ SerialCLI,\ we\ probably\ want\ to\ intercept\ this\ and\ print\ text.}}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ since\ we\ are\ refactoring,\ \`{}SerialCLI`\ should\ handle\ responses\ itself?}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ However,\ \`{}ControlLogic`\ calls\ \`{}CommandRouter::SendPacket`.}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ So\ we\ interpret\ it\ here.}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ Decode\ packet\ and\ print\ text?}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reuse\ DecodeAndPrintPacket\ logic\ from\ previous\ version\ or\ simplify?}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ now,\ let's\ just\ print\ a\ "{}TxPacket"{}\ debug\ line\ so\ we\ see\ what\ logic\ sent.}}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ prefix\ =\ \textcolor{stringliteral}{"{}[TX]\ "{}};}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)prefix,\ 5);}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(uint16\_t\ i=0;\ i<length;\ i++)\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ tmp[4];}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ sprintf(tmp,\ \textcolor{stringliteral}{"{}\%02X\ "{}},\ data[i]);}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)tmp,\ strlen(tmp));}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}((\textcolor{keyword}{const}\ uint8\_t*)\textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}},\ 2);}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \textcolor{preprocessor}{\#else }}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_hardware_ad3ec7cad074d6d73508844a06a7bea50}{Hardware::UART\_Send}}(data,\ length);}
\DoxyCodeLine{00259\ \textcolor{preprocessor}{\#endif }}
\DoxyCodeLine{00260\ \ \ \ \ \}}

\end{DoxyCode}


References \mbox{\hyperlink{_hardware_8cpp_source_l00261}{Hardware\+::\+UART\+\_\+\+Send()}}.



Referenced by \mbox{\hyperlink{_control_logic_8cpp_source_l01160}{Control\+Logic\+::\+Process\+Motion\+Short\+Logic()}}, \mbox{\hyperlink{_control_logic_8cpp_source_l01311}{Control\+Logic\+::\+Process\+Online\+Detect()}}, and \mbox{\hyperlink{_control_logic_8cpp_source_l01338}{Control\+Logic\+::\+Process\+REQx6()}}.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespace_command_router_a1cf14aabb538f71f140e6b1aa7ef965d_icgraph}
\end{center}
\end{figure}


\label{doc-var-members}
\Hypertarget{namespace_command_router_doc-var-members}
\doxysubsection{Variable Documentation}
\Hypertarget{namespace_command_router_a094713e616919d86425f209582f1af2c}\index{CommandRouter@{CommandRouter}!last\_packet\_time@{last\_packet\_time}}
\index{last\_packet\_time@{last\_packet\_time}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{last\_packet\_time}{last\_packet\_time}}
{\footnotesize\ttfamily \label{namespace_command_router_a094713e616919d86425f209582f1af2c} 
uint64\+\_\+t Command\+Router\+::last\+\_\+packet\+\_\+time = 0\hspace{0.3cm}{\ttfamily [static]}}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00018}{18}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00180}{Run()}}.

\Hypertarget{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef}\index{CommandRouter@{CommandRouter}!process\_buffer@{process\_buffer}}
\index{process\_buffer@{process\_buffer}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{process\_buffer}{process\_buffer}}
{\footnotesize\ttfamily \label{namespace_command_router_a0c881896984f67f62d7aecd8eaf92aef} 
uint8\+\_\+t Command\+Router\+::process\+\_\+buffer\mbox{[}1024\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00019}{19}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00076}{Init()}}, and \mbox{\hyperlink{_command_router_8cpp_source_l00180}{Run()}}.

\Hypertarget{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41}\index{CommandRouter@{CommandRouter}!process\_len@{process\_len}}
\index{process\_len@{process\_len}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{process\_len}{process\_len}}
{\footnotesize\ttfamily \label{namespace_command_router_a3db3bf06c2150bdce40ddb4b50999e41} 
volatile uint16\+\_\+t Command\+Router\+::process\+\_\+len = 0\hspace{0.3cm}{\ttfamily [static]}}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00020}{20}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00076}{Init()}}, and \mbox{\hyperlink{_command_router_8cpp_source_l00180}{Run()}}.

\Hypertarget{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba}\index{CommandRouter@{CommandRouter}!process\_ready@{process\_ready}}
\index{process\_ready@{process\_ready}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{process\_ready}{process\_ready}}
{\footnotesize\ttfamily \label{namespace_command_router_a6c1a63e82474f28710cde5df81d42aba} 
volatile bool Command\+Router\+::process\+\_\+ready = false\hspace{0.3cm}{\ttfamily [static]}}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00021}{21}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00076}{Init()}}, and \mbox{\hyperlink{_command_router_8cpp_source_l00180}{Run()}}.

\Hypertarget{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}\index{CommandRouter@{CommandRouter}!routeTable@{routeTable}}
\index{routeTable@{routeTable}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{routeTable}{routeTable}}
{\footnotesize\ttfamily \label{namespace_command_router_a8b873c3755f64e992caa60685b79ec45} 
const \mbox{\hyperlink{struct_command_router_1_1_route_entry}{Route\+Entry}} Command\+Router\+::route\+Table\mbox{[}$\,$\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}

{\bfseries Initial value\+:}
\begin{DoxyCode}{0}
\DoxyCodeLine{=\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9caa2cb872d6738be05568903e3cc0a0c77}{UnifiedCommandType::FilamentMotionShort}},\ \mbox{\hyperlink{namespace_control_logic_a5f85db884abd1a66d8b120729ec0d99e}{ControlLogic::ProcessMotionShort}},\ \textcolor{stringliteral}{"{}MotionShort"{}}\ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca84ef06344d5159ac0d02201780d584be}{UnifiedCommandType::FilamentMotionLong}},\ \ \mbox{\hyperlink{namespace_control_logic_a2ab840bfd454a7709553b89529285b74}{ControlLogic::ProcessMotionLong}},\ \ \textcolor{stringliteral}{"{}MotionLong"{}}\ \ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cadb5148c679935c8821fac8fad759922f}{UnifiedCommandType::OnlineDetect}},\ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a412a7a597ff3c04c0ea1480094600ef4}{ControlLogic::ProcessOnlineDetect}},\textcolor{stringliteral}{"{}OnlineDetect"{}}\},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca403d48ab34ede926334f42e9f1e118b2}{UnifiedCommandType::REQx6}},\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a82b9a1fb120cd91615d2ac478daafefd}{ControlLogic::ProcessREQx6}},\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}REQx6"{}}\ \ \ \ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cab72778b10468ded56d76c818eae14c76}{UnifiedCommandType::SetFilamentInfo}},\ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_ada1dd6f18fca06d8b26836f4788ab0ad}{ControlLogic::ProcessSetFilamentInfo}},\ \textcolor{stringliteral}{"{}SetFilament"{}}\ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca83622997d22f5f18b9b09bd364cb673e}{UnifiedCommandType::Heartbeat}},\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a0c4206af909c8128bc68eb6a1bcfa16e}{ControlLogic::ProcessHeartbeat}},\ \ \ \textcolor{stringliteral}{"{}Heartbeat"{}}\ \ \ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \}}

\end{DoxyCode}


Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00033}{33}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9caa2cb872d6738be05568903e3cc0a0c77}{UnifiedCommandType::FilamentMotionShort}},\ \mbox{\hyperlink{namespace_control_logic_a5f85db884abd1a66d8b120729ec0d99e}{ControlLogic::ProcessMotionShort}},\ \textcolor{stringliteral}{"{}MotionShort"{}}\ \},}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca84ef06344d5159ac0d02201780d584be}{UnifiedCommandType::FilamentMotionLong}},\ \ \mbox{\hyperlink{namespace_control_logic_a2ab840bfd454a7709553b89529285b74}{ControlLogic::ProcessMotionLong}},\ \ \textcolor{stringliteral}{"{}MotionLong"{}}\ \ \},}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cadb5148c679935c8821fac8fad759922f}{UnifiedCommandType::OnlineDetect}},\ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a412a7a597ff3c04c0ea1480094600ef4}{ControlLogic::ProcessOnlineDetect}},\textcolor{stringliteral}{"{}OnlineDetect"{}}\},}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca403d48ab34ede926334f42e9f1e118b2}{UnifiedCommandType::REQx6}},\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a82b9a1fb120cd91615d2ac478daafefd}{ControlLogic::ProcessREQx6}},\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}REQx6"{}}\ \ \ \ \ \ \ \},}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9cab72778b10468ded56d76c818eae14c76}{UnifiedCommandType::SetFilamentInfo}},\ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_ada1dd6f18fca06d8b26836f4788ab0ad}{ControlLogic::ProcessSetFilamentInfo}},\ \textcolor{stringliteral}{"{}SetFilament"{}}\ \},}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \{\ \mbox{\hyperlink{_command_types_8h_a9fa149d3b881fd0f62738e1de747ea9ca83622997d22f5f18b9b09bd364cb673e}{UnifiedCommandType::Heartbeat}},\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_control_logic_a0c4206af909c8128bc68eb6a1bcfa16e}{ControlLogic::ProcessHeartbeat}},\ \ \ \textcolor{stringliteral}{"{}Heartbeat"{}}\ \ \ \},}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Mapped\ Long\ Packets\ (Handler\ calls\ helper\ that\ parses\ long\ packet)}}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ CommandRouter::Route\ logic\ for\ these\ was\ effectively\ parsing\ long\ packet\ then\ calling\ ControlLogic::ProcessLongPacket}}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ make\ a\ helper\ in\ CommandRouter\ or\ ControlLogic.\ }}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Let's\ use\ a\ generic\ handler\ or\ specific\ wrapper\ if\ needed.}}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ now,\ mapping\ to\ a\ specialized\ handler\ or\ generic\ one.}}
\DoxyCodeLine{00045\ \ \ \ \ \ \};}

\end{DoxyCode}


Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00133}{Route()}}.

\Hypertarget{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac}\index{CommandRouter@{CommandRouter}!routeTableSize@{routeTableSize}}
\index{routeTableSize@{routeTableSize}!CommandRouter@{CommandRouter}}
\doxysubsubsection{\texorpdfstring{routeTableSize}{routeTableSize}}
{\footnotesize\ttfamily \label{namespace_command_router_af0e503624af5471ef481ef04f3ce4bac} 
const int Command\+Router\+::route\+Table\+Size = sizeof(\mbox{\hyperlink{namespace_command_router_a8b873c3755f64e992caa60685b79ec45}{route\+Table}}) / sizeof(\mbox{\hyperlink{struct_command_router_1_1_route_entry}{Route\+Entry}})\hspace{0.3cm}{\ttfamily [static]}}



Definition at line \mbox{\hyperlink{_command_router_8cpp_source_l00047}{47}} of file \mbox{\hyperlink{_command_router_8cpp_source}{Command\+Router.\+cpp}}.



Referenced by \mbox{\hyperlink{_command_router_8cpp_source_l00133}{Route()}}.

